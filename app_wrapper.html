<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RainMerge App</title>
  <style>
    * {margin:0; padding:0; box-sizing:border-box}
    html, body {height:100%; overflow:hidden}
    #appFrame {
      position:absolute;
      width:100%;
      height:100%;
      border:none;
      z-index:1;
    }
    #idleOverlay {
      position:absolute;
      width:100%;
      height:100%;
      top:0;
      left:0;
      z-index:10;
      display:none;
      pointer-events:none;
    }
    #idleOverlay.active {
      display:block;
      pointer-events:auto;
    }
    #idleFrame {width:100%; height:100%; border:none}
  </style>
</head>
<body>
  <!-- Guacamole session (NO sandbox for same-origin) -->
  <iframe
    id="appFrame"
    src="https://kiosk.sessionmanager.site"
    allow="clipboard-read; clipboard-write; fullscreen; display-capture; autoplay; microphone; camera"
    allowfullscreen
    style="width:100%; height:100%; border:none; z-index:1;">
  </iframe>
  
  <!-- Idle overlay -->
  <div id="idleOverlay">
    <iframe id="idleFrame" src="idle_index.html"></iframe>
  </div>
  
  <script>
    const BASE_URL = "https://kiosk.sessionmanager.site";
    const appFrame = document.getElementById('appFrame');
    const idleOverlay = document.getElementById('idleOverlay');
    
    appFrame.src = BASE_URL;
    
    // ðŸŽ¯ Ensure iframe gets focus for keyboard input
    appFrame.onload = () => {
      setTimeout(() => {
        try {
          appFrame.contentWindow.focus();
        } catch(e) {}
      }, 500);
    };
    
    function showIdle(reason){
      console.log('Showing idle screen:', reason);
      idleOverlay.classList.add('active');
    }
    
    function hideIdle(){
      console.log('Hiding idle screen, return to app');
      fetch(`${BASE_URL}/kiosk/go_home`, {mode:'no-cors'}).catch(()=>{});
      setTimeout(()=>{
        idleOverlay.classList.remove('active');
        idleOverlay.style.pointerEvents = 'none';
        
        // ðŸŽ¯ Refocus iframe after returning from idle
        try {
          appFrame.contentWindow.focus();
        } catch(e) {}
        
        resetIdleTimer();
      }, 150);
    }
    
    window.addEventListener('message', e => {
      if (e.data === 'idle_clicked') hideIdle();
    });
    
    // Idle timer - listen ONLY on wrapper, not inside iframe
    let idleTimer;
    function resetIdleTimer(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => showIdle('30 seconds of inactivity'), 30000);
    }
    
    // âœ… Don't use capture phase (no 'true')
    // âœ… Listen on document, events from iframe will bubble up
    ['mousedown','mousemove','keypress','touchstart','wheel']
      .forEach(evt => document.addEventListener(evt, resetIdleTimer));
    
    resetIdleTimer();
    
    // Exit check
    setInterval(async () => {
      try {
        const res = await fetch(`${BASE_URL}/kiosk/check_exit`, {cache:'no-store',mode:'no-cors'});
        if (res && res.ok) {
          const txt = await res.text();
          if (txt.trim() === 'EXITED') showIdle('PyQt Exit button clicked');
        }
      } catch(_) {}
    }, 1000);
  </script>
</body>
</html>
