<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RainMerge App</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden}
    #appFrame{position:absolute;width:100%;height:100%;border:none;display:block;z-index:1}
    #idleOverlay{position:absolute;width:100%;height:100%;top:0;left:0;z-index:10;display:none}
    #idleOverlay.active{display:block}
    #idleFrame{width:100%;height:100%;border:none}
  </style>
</head>
<body>
  <!-- The RDP session frame -->
  <iframe id="appFrame" allow="clipboard-read; clipboard-write"></iframe>

  <!-- Idle overlay -->
  <div id="idleOverlay">
    <iframe id="idleFrame" src="idle_index.html"></iframe>
  </div>

  <script>
    // Use your active Cloudflare tunnel instead of GitHub Pages origin
    const BASE_URL = "https://both-industry-cent-magnitude.trycloudflare.com";
    document.getElementById('appFrame').src = `${BASE_URL}/launch`;
    console.log('RainMerge App Wrapper loaded - Base URL:', BASE_URL);

    const idleOverlay = document.getElementById('idleOverlay');

    function showIdle(reason){
      console.log('Showing idle screen:', reason);
      idleOverlay.classList.add('active');
    }

    function hideIdle(){
      console.log('Hiding idle screen, return to app');
      fetch(`${BASE_URL}/kiosk/go_home`).catch(()=>{});
      setTimeout(()=>{
        idleOverlay.classList.remove('active');
        resetIdleTimer();
        console.log('Page 0 shown');
      },150);
    }

    window.addEventListener('message',(e)=>{
      if(e.data === 'idle_clicked') hideIdle();
    });

    let idleTimer;
    function resetIdleTimer(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(()=>showIdle('30 seconds of inactivity'), 30000);
    }
    ['mousedown','mousemove','keypress','scroll','touchstart','click','wheel']
      .forEach(evt=>document.addEventListener(evt, resetIdleTimer, true));
    resetIdleTimer();

    // Exit detection (optional)
    setInterval(async ()=>{
      try{
        const res = await fetch(`${BASE_URL}/kiosk/check_exit`, {cache:'no-store'});
        if(res.ok){
          const txt = await res.text();
          if(txt === 'EXITED'){
            console.log('Exit detected from PyQt, show screensaver');
            showIdle('PyQt Exit button clicked');
          }
        }
      }catch(_){}
    }, 500);
  </script>
</body>
</html>
