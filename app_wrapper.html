<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainMerge Kiosk</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        
        /* App Screen - Always loaded */
        #appScreen {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
        }
        
        #appScreen iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Idle Screen - Overlays on top */
        #idleScreen {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 10;
            background: radial-gradient(ellipse at bottom, #0b132b 0%, #000 100%);
            cursor: pointer;
            display: none; /* Hidden by default */
        }
        
        #idleScreen.active {
            display: block;
        }
        
        #idleHint {
            position: absolute;
            left: 50%;
            top: 10%;
            transform: translateX(-50%);
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.5);
            animation: pulse 3s infinite;
            font-family: sans-serif;
            text-align: center;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.8; }
        }
        
        /* Status */
        #status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 11px;
            z-index: 20;
        }
        #status.active { background: rgba(0, 128, 0, 0.7); }
    </style>
</head>
<body>
    <div id="status">üîÑ Connecting...</div>
    
    <!-- APP SCREEN - Loads once, stays loaded! -->
    <div id="appScreen">
        <iframe src="http://localhost:8080/guacamole/" allow="clipboard-read; clipboard-write"></iframe>
    </div>
    
    <!-- IDLE SCREEN - Overlays when needed -->
    <div id="idleScreen">
        <div id="idleHint">Click anywhere to continue...</div>
        <canvas id="globeCanvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        console.log('üöÄ RainMerge Kiosk loaded');
        
        const statusEl = document.getElementById('status');
        const idleScreen = document.getElementById('idleScreen');
        let currentMode = 'app';
        
        // ===== EXIT POLLING =====
        async function checkExit() {
            try {
                const response = await fetch('http://localhost:8081/check_exit');
                const text = await response.text();
                
                if (text === 'EXITED') {
                    console.log('üö™ EXIT DETECTED - Showing idle screen');
                    showIdle();
                    statusEl.textContent = 'üí§ Idle mode';
                } else {
                    // Update status occasionally
                    if (currentMode === 'app' && Math.random() < 0.02) {
                        statusEl.textContent = '‚úÖ Active';
                        statusEl.className = 'active';
                    }
                }
            } catch (error) {
                statusEl.textContent = '‚ö†Ô∏è Offline';
            }
        }
        
        // Poll every 500ms
        setInterval(checkExit, 500);
        checkExit();
        
        // ===== IDLE TIMER (30s backup) =====
        let idleTimer;
        
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                if (currentMode === 'app') {
                    console.log('‚è∞ 30s inactive - showing idle screen');
                    showIdle();
                }
            }, 30000);
        }
        
        ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'].forEach(e => {
            document.addEventListener(e, () => {
                if (currentMode === 'app') resetIdleTimer();
            }, true);
        });
        
        resetIdleTimer();
        
        // ===== SCREEN MANAGEMENT =====
        function showIdle() {
            idleScreen.classList.add('active');
            currentMode = 'idle';
            console.log('üí§ Idle screen shown (Guacamole still loaded underneath!)');
            initGlobe();
        }
        
        function hideIdle() {
            idleScreen.classList.remove('active');
            currentMode = 'app';
            statusEl.textContent = '‚úÖ Active';
            statusEl.className = 'active';
            resetIdleTimer();
            console.log('üì± App screen shown (Guacamole never reloaded!)');
        }
        
        // Click idle screen to return to app
        idleScreen.addEventListener('click', hideIdle);
        
        // ===== 3D GLOBE =====
        let globeInitialized = false;
        
        function initGlobe() {
            if (globeInitialized) return;
            globeInitialized = true;
            
            const canvas = document.getElementById('globeCanvas');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 4;
            
            const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            // Globe
            const globe = new THREE.Mesh(
                new THREE.SphereGeometry(1, 32, 32),
                new THREE.MeshPhongMaterial({ color: 0x2194ce, emissive: 0x112244, shininess: 20 })
            );
            scene.add(globe);
            
            // Wireframe
            const wireframe = new THREE.Mesh(
                new THREE.SphereGeometry(1.02, 24, 24),
                new THREE.MeshBasicMaterial({ color: 0x4fc3f7, wireframe: true, transparent: true, opacity: 0.4 })
            );
            scene.add(wireframe);
            
            // Stars
            const starsGeo = new THREE.BufferGeometry();
            const starsVerts = [];
            for (let i = 0; i < 3000; i++) {
                const r = 100, theta = Math.random() * Math.PI * 2, phi = Math.acos(2 * Math.random() - 1), rad = r + Math.random() * 50;
                starsVerts.push(rad * Math.sin(phi) * Math.cos(theta), rad * Math.sin(phi) * Math.sin(theta), rad * Math.cos(phi));
            }
            starsGeo.setAttribute('position', new THREE.BufferAttribute(new Float32Array(starsVerts), 3));
            scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({ color: 0xffffff, size: 2 })));
            
            // Lights
            scene.add(new THREE.AmbientLight(0x404040, 3));
            const light = new THREE.DirectionalLight(0xffffff, 1.5);
            light.position.set(5, 3, 5);
            scene.add(light);
            
            // Animate
            function animate() {
                requestAnimationFrame(animate);
                globe.rotation.y += 0.003;
                wireframe.rotation.y -= 0.002;
                renderer.render(scene, camera);
            }
            animate();
            
            // Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            console.log('üåç Globe initialized');
        }
        
        console.log('‚úÖ Kiosk system ready');
        console.log('üì± Guacamole loads once and stays loaded!');
        console.log('üí§ Idle screen overlays on top when needed');
    </script>
</body>
</html>
