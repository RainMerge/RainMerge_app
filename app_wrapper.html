<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RainMerge App</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html, body { 
            height: 100%; 
            overflow: hidden; 
        }
        
        /* Guacamole frame - always visible */
        #appFrame {
            position: absolute;
            width: 100%; 
            height: 100%;
            border: none; 
            display: block;
            z-index: 1;
        }
        
        /* Idle overlay - shows on top when needed */
        #idleOverlay {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 10;
            display: none; /* Hidden by default */
        }
        
        #idleOverlay.active {
            display: block;
        }
        
        #idleFrame {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <!-- Guacamole - stays loaded! -->
    <iframe 
        id="appFrame" 
        src="http://localhost:8080/guacamole/#/client/UHlRdDUgQXBwAGMAZGVmYXVsdA" 
        allow="clipboard-read; clipboard-write">
    </iframe>
    
    <!-- Idle screen overlay - your idle_index.html -->
    <div id="idleOverlay">
        <iframe id="idleFrame" src="idle_index.html"></iframe>
    </div>
    
    <script>
        console.log('ðŸš€ RainMerge App Wrapper loaded');
        
        const idleOverlay = document.getElementById('idleOverlay');
        
        // ===== SHOW/HIDE IDLE SCREEN =====
        function showIdle(reason) {
            console.log(`ðŸŒ™ Showing idle screen: ${reason}`);
            idleOverlay.classList.add('active');
            console.log('ðŸ’¤ Idle overlay shown - Guacamole still running!');
        }
        
        function hideIdle() {
            console.log('ðŸ“± Hiding idle screen - returning to app');
            idleOverlay.classList.remove('active');
            resetIdleTimer();
            console.log('âœ… App visible - Guacamole never reloaded!');
        }
        
        // Listen for clicks from idle iframe
        window.addEventListener('message', (e) => {
            if (e.data === 'idle_clicked') {
                console.log('ðŸ‘† Click detected in idle screen');
                hideIdle();
            }
        });
        
        // ===== IDLE TIMER =====
        let idleTimer;
        
        function resetIdleTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                showIdle('30 seconds of user inactivity');
            }, 30000); // 30 seconds
        }
        
        // Track user activity
        const activityEvents = [
            'mousedown', 
            'mousemove', 
            'keypress', 
            'scroll', 
            'touchstart', 
            'click', 
            'wheel'
        ];
        
        activityEvents.forEach(event => {
            document.addEventListener(event, resetIdleTimer, true);
        });
        
        // Start idle timer
        resetIdleTimer();
        console.log('âœ… Inactivity timer active (30 seconds)');
        
        // ===== EXIT DETECTION VIA HTTP =====
        let exitCheckInterval = setInterval(async () => {
            try {
                const response = await fetch('http://localhost:8081/check_exit', {
                    method: 'GET',
                    cache: 'no-store'
                });
                
                if (response.ok) {
                    const text = await response.text();
                    
                    if (text === 'EXITED') {
                        console.log('ðŸšª EXIT DETECTED from PyQt!');
                        console.log('   â†’ Going to screensaver immediately');
                        
                        showIdle('PyQt Exit button clicked');
                    }
                }
            } catch (error) {
                // HTTP server not responding yet, that's ok
            }
        }, 500); // Check every 500ms
        
        console.log('âœ… Exit detection active (polling every 500ms)');
        console.log('ðŸ“¡ Watching: http://localhost:8081/check_exit');
        
        console.log('\nðŸŽ¯ TWO IDLE TRIGGERS:');
        console.log('   1. Exit button in PyQt â†’ Instant screensaver');
        console.log('   2. 30s inactivity â†’ Screensaver');
        console.log('âš¡ Overlay system - no reload delay!');
    </script>
</body>
</html>
