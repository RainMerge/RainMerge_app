<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RainMerge App</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%;overflow:hidden}
    #appFrame{position:absolute;width:100%;height:100%;border:none;z-index:1}
    #idleOverlay{position:absolute;width:100%;height:100%;top:0;left:0;z-index:10;display:none}
    #idleOverlay.active{display:block}
    #idleFrame{width:100%;height:100%;border:none}
  </style>
</head>
<body>
  <!-- Guacamole session -->
  <iframe id="appFrame" allow="clipboard-read; clipboard-write"></iframe>

  <!-- Idle overlay -->
  <div id="idleOverlay">
    <iframe id="idleFrame" src="idle_index.html"></iframe>
  </div>

  <script>
    // Fixed backend base (Cloudflare tunnel)
    const BASE_URL = "https://kiosk.sessionmanager.site";
    const appFrame = document.getElementById('appFrame');
    appFrame.src = `${BASE_URL}`;   // âœ… always correct

    const idleOverlay = document.getElementById('idleOverlay');

    function showIdle(reason){
      console.log('Showing idle screen:', reason);
      idleOverlay.classList.add('active');
    }

    function hideIdle(){
      console.log('Hiding idle screen, return to app');
      fetch(`${BASE_URL}/kiosk/go_home`, {mode:'no-cors'}).catch(()=>{});
      setTimeout(()=>{
        idleOverlay.classList.remove('active');
        resetIdleTimer();
      },150);
    }

    // Click from idle iframe
    window.addEventListener('message',e=>{
      if(e.data === 'idle_clicked') hideIdle();
    });

    // Idle timer
    let idleTimer;
    function resetIdleTimer(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(()=>showIdle('30 seconds of inactivity'), 30000);
    }
    ['mousedown','mousemove','keypress','scroll','touchstart','click','wheel']
      .forEach(evt=>document.addEventListener(evt, resetIdleTimer, true));
    resetIdleTimer();

    // Optional exit check
    setInterval(async ()=>{
      try{
        const res = await fetch(`${BASE_URL}/kiosk/check_exit`, {cache:'no-store',mode:'no-cors'});
        if(res && res.ok){
          const txt = await res.text();
          if(txt.trim()==='EXITED') showIdle('PyQt Exit button clicked');
        }
      }catch(_){}
    }, 1000);
  </script>
</body>
</html>
